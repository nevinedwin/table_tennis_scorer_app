AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: "TTAppTable Application"


Parameters:
  StageName: 
    Default: debug
    Type: String
    AllowedValues:
      - local
      - debug
      - dev
      - prod

  SSLCertificateArn:
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/ttApp/Application/sslCertificateArn"

  GoogleClientId:
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/ttApp/Application/googleClientId"

  GoogleSecretKey:
    Type: AWS::SSM::Parameter::Value<String>
    Default: "/ttApp/Application/googleSecretKey"

  IsEnableCustomDomain:
    Type: String
    Default: "true"
    AllowedValues:
         - "true"
         - "false"

Mappings:
  URLs:
    debug:
      URL: "https://khel.ns-info.xyz/index.html"
    dev:
      URL: https://dev-khel.inapp.com/index.html
    prod:
      URL: https://khel.inapp.com/index.html
    local:
      URL: http://localhost:5173/
  DomainName:
    debug:
      URL: khel.ns-info.xyz
    dev:
      URL: dev-khel.inapp.com
    prod:
      URL: khel.inapp.com
  ApiDomainName:
    debug:
      URL: api-khel.ns-info.xyz
    dev:
      URL: api-dev-khel.inapp.com
    prod:
      URL: api-khel.inapp.com
  StackNamePrefix:
    debug:
      Name: ttapp-debug-stack
    dev:
      Name: ttapp-dev-stack
    prod:
      Name: ttapp-stack
    local:
      Name: ttapp-local-stack


Resources:
  LambdaLayerStack:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./lambdaLayerStack/template.yaml
      Parameters:
        StageName: !Ref StageName
        StackNamePrefix: !FindInMap [StackNamePrefix, !Ref StageName, Name]
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  
  DynamoDbTableStack:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./dynamodbStack/template.yaml
      Parameters:
        StageName: !Ref StageName
        StackNamePrefix: !FindInMap [StackNamePrefix, !Ref StageName, Name]
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  
  AccessIdentiyStack:
    Type: AWS::Serverless::Application
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      Location: ./infrastructure/access-identity-template.yaml
      Parameters:
        StackNamePrefix: !FindInMap [StackNamePrefix, !Ref StageName, Name]

  FrontendBucketStack:
    Type: AWS::Serverless::Application
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      Location: ./infrastructure/frontend-bucket-template.yaml
      Parameters:
        StageName: !Ref StageName
        StackNamePrefix: !FindInMap [StackNamePrefix, !Ref StageName, Name]
        IsEnableCustomDomain: !Ref IsEnableCustomDomain
        DomainName: !Sub
          - https://${domain}
          - domain: !FindInMap [DomainName, !Ref StageName, URL]
        S3CanonicalUserId: !GetAtt AccessIdentiyStack.Outputs.S3CanonicalUserId
  
  CloudFrontStack:
    Type: AWS::Serverless::Application
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
    Properties:
      Location: ./infrastructure/cloudfront-template.yaml
      Parameters:
        FrontendBucketDomainName: !GetAtt FrontendBucketStack.Outputs.FrontendBucketDomainName
        TTAppOriginAccessIdentity: !GetAtt AccessIdentiyStack.Outputs.TTAppOriginAccessIdentity
        IsEnabledCustomeDomain: !Ref IsEnableCustomDomain
        Alias: !FindInMap [DomainName, !Ref StageName, URL ]
        SSLCertificateArn: !Ref SSLCertificateArn

  CognitoStack:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./cognitoStack/template.yaml
      Parameters:
        StageName: !Ref StageName
        URLs: !FindInMap [URLs, !Ref StageName, URL]
        GoogleClientId: !Ref GoogleClientId
        GoogleSecretKey: !Ref GoogleSecretKey
        TTAppLayer: !GetAtt LambdaLayerStack.Outputs.TTAppLayer
        TableName: !GetAtt DynamoDbTableStack.Outputs.TTAppTableName
        TTAppTableArn: !GetAtt DynamoDbTableStack.Outputs.TTAppTableArn
        StackNamePrefix: !FindInMap [StackNamePrefix, !Ref StageName, Name]
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  
  FunctionStack:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./functionStack/template.yaml
      Parameters:
        StageName: !Ref StageName
        UserPoolArn: !GetAtt CognitoStack.Outputs.UserPoolArn
        TTAppLayer: !GetAtt LambdaLayerStack.Outputs.TTAppLayer
        TableName: !GetAtt DynamoDbTableStack.Outputs.TTAppTableName
        TTAppTableArn: !GetAtt DynamoDbTableStack.Outputs.TTAppTableArn
        TTAppTableIndex: !GetAtt DynamoDbTableStack.Outputs.TTAppTableIndexName
        StackNamePrefix: !FindInMap [StackNamePrefix, !Ref StageName, Name]
        WebSocketUrl: !GetAtt SocketStack.Outputs.TTAppWebSocketGatewayEndpoint
        WebSocketPostUrl: !GetAtt SocketStack.Outputs.TTAppWebSocketGatewayPOSTEndpoint
        TTAppDynamoStreamARN: !GetAtt DynamoDbTableStack.Outputs.TTAppDynamoStreamARN
        IsEnableCustomDomain: !Ref IsEnableCustomDomain
        ApiDomainName: !FindInMap [ApiDomainName, !Ref StageName, URL]
        SSLCertificateArn: !Ref SSLCertificateArn
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

  SocketStack:
    Type: AWS::Serverless::Application
    Properties:
      Location: ./socketStack/template.yaml
      Parameters:
        StageName: !Ref StageName
        UserPoolId: !GetAtt CognitoStack.Outputs.UserPoolId
        UserPoolClientId: !GetAtt CognitoStack.Outputs.UserPoolClientId
        TTAppLayer: !GetAtt LambdaLayerStack.Outputs.TTAppLayer
        TableName: !GetAtt DynamoDbTableStack.Outputs.TTAppTableName
        TTAppTableArn: !GetAtt DynamoDbTableStack.Outputs.TTAppTableArn
        TTAppTableIndex: !GetAtt DynamoDbTableStack.Outputs.TTAppTableIndexName
        StackNamePrefix: !FindInMap [StackNamePrefix, !Ref StageName, Name]
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete

Outputs:
  TTAppApiURL:
    Description: Api Gateway base url
    Value: !GetAtt FunctionStack.Outputs.TTAppApiURL
  
  UserPoolId:
    Description: User pool ID
    Value: !GetAtt CognitoStack.Outputs.UserPoolId
  
  UserPoolClientId:
    Description: User pool Client ID
    Value: !GetAtt CognitoStack.Outputs.UserPoolClientId

